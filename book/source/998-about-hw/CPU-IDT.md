# CPU之IDT

IDT(Interrupt Descriptor Table)即：中断描述符表。它是Intel x86和x86_64机器中特有的一种结构，用来保存中断描述符。每个中断描述符都可以表示一个中断处理程序的属性和位置。

在16位和32位机器上每个中断描述符占用8字节(64位)；在64位模式下会扩展为16字节(128位)。

中断描述符的入口被称为 门(gates)，这些门可以分为：中断门、任务门、陷阱门。

IDT的位置保存在IDTR寄存器中(Interrupt Descript Table Register)。使用LIDT指令加载IDT表。

IDT中前256各中断向量(0 ... 255)是预定义好的，尽管IDT中可以包含超过256各中断，但是超过256部分都会被忽略。

## IDTR

### 32位IDTR

32位模式下IDT每个元素使用了48位，低16位是Limit位，即IDT字节大小减1。后32位表示IDT的基地址，即IDT在内存中的线性地址。

```
 48               16 15      0
+-------------------+---------+
|  Base             | Limit   |
+-------------------+---------+
```

### 64位IDTR

```
 79               16 15      0
+-------------------+---------+
|  Base             | Limit   |
+-------------------+---------+
```

Limit 表示了IDT表的长度。

## IDT

### 32-bit IDT

在32-bit环境下，每个中断向量表中的元素占用8字节

|地址              |内容   |
|------------------|-------|
|IDTR Offset + 0   |入口0  |
|IDTR Offset + 8   |入口1  |
| ---              | ...   |
|IDTR Offset + 2040|入口255|

每个元素的格式如下：

```
 63                     48   47  46  45  44  43      40  39         32
+--------------------------+----+-------+---+-----------+-------------+
| Offset                   | P  | DPL   | 0 | Gate Type | Reserved    |
| 31                    16 |    | 1   0 |   | 3       0 |             |
+--------------------------+----+-------+---+-----------+-------------+

 31                           16  15                                 0
+-------------------------------+-------------------------------------+
| Segment Selector              | Offset                              |
| 15                          0 | 15                                0 |
+-------------------------------+-------------------------------------+
```
每个字段含义如下：
- Offset：一个32-bit值，占2个部分。它代表中断服务入口地址。
- Segment Selector：段选择子必须指向GDT合法的代码段
- Gate Type：一个4-bit值，用来指示中断门的类型
    - 0101(0x5)：任务门，此类门中Offset的值必须置为0
    - 0110(0x6)：16-bit中断门
    - 0111(0x7)：16-bit陷阱门
    - 1110(0xE)：32-bit中断门
    - 1111(0xF)：32-bit陷阱门
- DPL：2-bit值，定义了CPU特权级别，确定是否允许INT指令访问这个中断。硬件中断自动忽略此值。
- P：1-bit，指示中断是否可用，必须设置为1。

C结构：
```c
struct InterruptDescriptor32 
{
   uint16_t offset_1;        // offset bits 0..15
   uint16_t selector;        // a code segment selector in GDT or LDT
   uint8_t  zero;            // unused, set to 0
   uint8_t  type_attributes; // gate type, dpl, and p fields
   uint16_t offset_2;        // offset bits 16..31
};
```

### 64-bit IDT

```
 127                                                                    96
+--------------------------------------------------------------------------+
| Reserved                                                                 |
|                                                                          |
+--------------------------------------------------------------------------+

 95                                                                     64
+--------------------------------------------------------------------------+
| Offset                                                                   |
| 63                                                                    32 |
+--------------------------------------------------------------------------+

 63                     48   47  46  45  44  43      40  39     35   34  32
+--------------------------+----+-------+---+-----------+----------+-------+
| Offset                   | P  | DPL   | 0 | Gate Type | Reserved | IST   |
| 31                    16 |    | 1   0 |   | 3       0 |          | 2   0 |
+--------------------------+----+-------+---+-----------+----------+-------+

 31                           16  15                                      0
+-------------------------------+------------------------------------------+
| Segment Selector              | Offset                                   |
| 15                          0 | 15                                     0 |
+-------------------------------+------------------------------------------+
```
每个字段的含义：
- Offset：64-bit值，由3部分组成。中断程序入口地址。
- selector：段选择子，指向GDT合法的段选择子
- IST：3-bit值。中断堆栈表偏移，常用于任务堆栈段。如果字段都设置为0，中断堆栈表不可用。
- Gate Type：4-bit值，定义了中断描述符的类型，64-bit环境下只有两个可用值：
    - 0b1110(0xE)：64-bit 中断门
    - 0b1111(0xF)：64-bit 陷阱门
- DPL：2-bit值，定义了CPU权限级别，确定INT指令是否可以访问此中断描述符。硬件中断忽略此值。
- P：此中断是否可用，默认置1.

> 注意：64位IDT中断服务程序中，请使用 `IREQ`指令而不是`IRET`指令从中断中返回。

C 结构：
```c
struct InterruptDescriptor64 
{
   uint16_t offset_1;        // offset bits 0..15
   uint16_t selector;        // a code segment selector in GDT or LDT
   uint8_t  ist;             // bits 0..2 holds Interrupt Stack Table offset, rest of bits zero.
   uint8_t  type_attributes; // gate type, dpl, and p fields
   uint16_t offset_2;        // offset bits 16..31
   uint32_t offset_3;        // offset bits 32..63
   uint32_t zero;            // reserved
};
```

## IDT 门类型

从本质上来说共有2种中断类型：
1. 在代码执行过程中，执行到错误代码导致程序异常，此时当前指令指针所指指令是错误的、不可执行的，这种中断被称为陷阱。
2. 在代码执行过程中，发生其它事件触发处理与当前代码不相关的代码，此时要保存下条指令地址，以便返回后正常执行此代码。这种中断一般是由IRQ、硬件事件或者 `INT` 指令触发。

需要注意的是，当CPU处理IRQ请求时候要屏蔽中断，直到IRQ请求处理结束。

### 中断门

使用中断门来指定中断服务例程。比如：在保护模式下使用汇编指令 `INT 50` 触发一个中断，CPU 会在IDT中查找到对应的中断入口，然后加载中断描述符和偏移量，使用中断描述符和偏移来调用中断服务例程，当中断服务例程执行IRET之后，CPU从中断例程中返回。如果CPU运行在32-bit模式下，此时触发了16-bit中断门，会导致CPU切换到16-bit的中断处理程序并以16-bit环境运行，在中断例程结束后要执行`IRET`指令返回，否则CPU将不知道它应该执行32-bit的返回(读取堆栈上32-bit值，而不是16位)，返回后CPU切换回32-bit工作模式

进入中断门会自动关闭中断，返回后自动打开中断。

### 陷阱门

进入陷阱门后一般要处理异常情况。当触发陷阱门时候，堆栈上一定发生了错误，因此在退出中断例程前要弹出推展上错误数据，然后执行 IRET 退出中断处理例程。

进入陷阱门不会自动关闭中断，因此在陷阱门处理例程中可能再次触发中断。

### 任务门

任务门是32-bit机器下用于任务切换的一种机制。对于任务门，在GDT中应该对应一个任务段，而不是代码段，此时不需要`Offset`值，应该置0。当CPU处理此中断时候会切换到另一个任务，而不是执行一段代码。被中断的任务指针将被存储在`TSS`中`Task Link`字段中。

当任务门被触发时候，CPU会自动进入任务切换流程，这一操作是由硬件完成的。

在切换过程中，CPU临时禁用中断(相当于自动清除IF标志位)，保证任务切换的所有操作是原子的。

中断会在切换完成后，根据目标任务的TSS中的状态决定是否重新启用。

#### 保证原子性

1. CPU 会保存当前任务的上下文(包括寄存器、段寄存器、堆栈指针等)到当前任务的TSS。
2. 加载任务门指定的新任务的TSS，并恢复新任务的上下文。

任务切换完成后，根据新任务的IF标志位确定中断是否会重新启用。

任务门和TSS机制不允许嵌套任务切换：如果一个任务已经触发任务切换，硬件会所定任务状态，直到当前任务切换完成，才会接受新的中断或任务切换请求。

**由于任务门切换任务太过缓慢，因此x86_64已经弃用这种任务切换方式。**
