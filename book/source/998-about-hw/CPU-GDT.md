# CPU 之 GDT

## 什么是GDT

GDT即全局描述符表(Global Descript Table)，是x86 系列CPU提供的一种内存分段机制，主要用于保护模式。

GDT是一个数组，每个数组元素称为一个段描述符，每个段描述符包含了一个段的基地址、段限长(Limit)、访问权限信息。

CPU有专门的寄存器保存GDT地址，这个寄存器就是GDTR(Global Descript Table Register)寄存器。

段描述符结构如下：
- 基地址：段的起始地址
- 段限长：定义段的长度
- 访问权限：控制段的访问类型(如：代码段、数据段、系统段) 和 特权级(Ring0 到 Ring3)

## GDT由来

### 8086

8086是20世纪70年代很重要的一款16位CPU，最大寻址空间为 1MB，时钟频率4.77MHz - 10MHz之间，主要支持基本的计算和数据处理。

> 正常情况下16位CPU可寻址范围是：`2^16 = 64KB`，而8086可最大寻址空间为 `1MB` 就是得益于使用了分段寻址模式。

8086采用分段寻址模式，这种模式结合了段寄存器和偏移量来访问内存。
8086四个段寄存器：
- CS(Code Segment): 指向当前代码段，配合IP(Intruction Pointer)指令指针寄存器使用
- DS(Data Segment): 指向当前数据段，配合AX、BX、CX、DX这些通用寄存器使用。默认情况下，数据操作会使用DS作为数据段
- SS(Stack Segment): 指向当前堆栈段，SS指向当前堆栈段，进行函数调用、局部变量存储等操作。配合SP(Stack Pointer)，指向堆栈的顶部。BP(Base Pointer)，常用于访问堆栈中的参数和局部变量。
- ES(Extra Segment): 用于额外的数据段，通常在字符串操作中使用。在字符串操作中于DI配合使用(DS:SI -- ES:DI)。

计算物理地址：
```
物理地址=(段寄存器的值 x 16) + 偏移量
```
或者说
```
物理地址=(段寄存器 左移4位) + 偏移量
```

寻址方式：
- 直接寻址：
  ```
  MOV AX, [0x0010]      ; 从当前段(DS)的偏移量0x0010读取数据到AX寄存器
  ```
- 间接寻址：
  ```
  MOV BX, [2000H]       ; 将 2000H 存入BX
  MOV AX, [BX]          ; 从BX寄存器指定的地址(DS:BX)读取数据到AX
  ```
- 基址寻址：
  ```
  MOV AX, [BX + 4]      ; 使用寄存器+偏移量结合来寻址
  ```
- 索引寻址：
  ```
  MOV AX, [SI + 2]      ; 使用索引寄存器(如DS:SI或ES:DI)于偏移量结合确定地址,
                        ; 常用于操作数组
  ```
- 相对寻址：相对寻址主要用于控制流的跳转，偏移量相对于指令指针(IP)计算。

### 80286

80286 和 8086 一样都是16位架构，只是主频比8086高(通常在6MHz到25MHz之间)，因为引入了保护模式，所以可以支持多达16MB的内存寻址。

80286段寄存器工作原理：
- 在80286保护模式下，每个段寄存器保存的是一个**段选择符**，此段选择符会指向全局描述符表(GDT)中的段描述符
- 每个段描述符包含段基地址、限长、权限信息

80286地址总线是24位，因此可最大寻址16MB(2^24=16MB)，而寄存器是16位的，因此每个段可寻址范围是64KB(2^16=64KB)，这样最多支持16个寄存器就可完成16MB寻址。


