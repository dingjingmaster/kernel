# Hardened usercopy

内核经常将数据从用户空间复制到用户空间，这使得`copy_to_user()` 和`copy_from_user()`（及其友函数）成为经常使用的内核函数。但是，如果可以欺骗内核在任何一个方向上复制过多的数据，则可能导致安全漏洞。很久以前，grsecurity添加了`PAX_USERCOPY`特性（由PaX团队创建）来加强这些调用，因此即使内核中其他地方编写得很差的代码也不能真正复制超出它应该复制的数量。基于`PAX_USERCOPY`的代码现在被提议包含到主线内核中。

Kees Cook在7月初发布了第一个版本的“加固用户拷贝”补丁。这些补丁基于Casey Schaufler为将`PAX_USERCOPY`特性从grsecurity移植到主线所做的一些早期工作。从本质上讲，它试图确保用于在用户空间之间复制数据的地址范围是有效的。Cook也在为`PAX_USERCOPY`功能的另外两个部分做补丁；这一部分通过`CONFIG_HARDENED_USERCOPY`选项配置到内核中。

错误的用户空间复制可能导致的主要问题是，将太多数据复制到用户空间，导致内核内存的内容泄漏，或者从用户空间复制了太多数据，这可能会覆盖内核内存。如果攻击者能够影响内核堆上对象的分配，然后覆盖其中的一些对象，那么他们可能会升级特权、运行任意代码或使内核崩溃。信息泄漏通常不太危险，但内核确实有可能暴露关键数据（例如密钥）。除此之外，通过信息泄漏确定内核内存的布局还可以提供利用其他内核缺陷所需的信息。

这些补丁为`copy_*_user()`函数添加了几个参数测试，它们具有以下原型：

```c
long copy_from_user(void *to, const void __user * from, unsigned Long n);
long copy_to_user(void __user *to, const void *from, unsigned Long n);
```

每个调用都包含一个用户空间指针和一个内核空间指针；当前内核中已经检查了用户空间指针，因此补丁只添加了对内核空间指针的测试。这些测试确保地址范围不会超过内存的末尾，内核空间指针不为空，并且它不指向零长度的`kmalloc()`分配（即`ZERO_OR_NULL_PTR()`为假）。此外，如果地址范围与内核文本（代码）段重叠，它将被拒绝。

除此之外，如果内核空间地址指向一个已经从slab分配器分配的对象，那么补丁会确保被复制的内容符合分配对象的大小。这种检查是通过在内核地址上调用`pageSlab()`来执行的，以查看它是否位于由slab分配器处理的页面中；然后，它调用一个特定于分配器的例程来确定要复制的数据量是否完全在已分配的对象内。如果地址范围不是由slab分配器处理的，那么补丁将测试它是否在单个或复合页面中，并且它不跨越独立分配的页面。

此外，对于涉及堆栈的复制，复制的范围必须适合当前进程的堆栈。如果体系结构支持识别堆栈帧，则复制的范围必须适合于单个帧。

在所有情况下，测试失败的地址范围将生成包含相关信息的日志消息。它还将调用`BUG()`来生成内核漏洞并杀死当前进程（即试图利用某种内核漏洞的进程）。

补丁集分为三个逻辑块：添加测试的主补丁、为特定体系结构启用该特性的补丁（最初是x86、arm、arm64、ia64、powerpc和sparc，在最近的补丁集中添加了s390），以及为SLAB和SLUB分配器添加堆检查支持的两个补丁。库克指出，grsecurity中对SLOB分配器的支持“似乎完全中断了”，因此他专注于测试SLAB和SLUB。此外，堆栈帧检查仅在x86上实现。

库克说，在运行内核构建和hackbench等测试时，他“无法检测到启用这些功能后的可测量性能变化”。这表明该功能可能会在某个时候默认开启，尽管目前它是默认关闭的。Ingo Molnar建议运行一个系统调用繁重的工作负载，看看是否有任何可测量的性能下降，因为他也希望看到默认情况下启用该功能。Linus Torvalds说`stat()`繁重的工作负载（例如git diff）是测试它的一种方法，但他表示他认为检查不会那么繁重。

Andy Lutomirski想知道是否应该给一些用于验证被复制对象的基础设施起一个不同的名字，因为将来它可能会扩展到不仅仅是“usercopy”。这引发了Molnar和PaX团队之间关于功能、威胁模型和“自行车修剪”的争论。然而，库克成功地扑灭了摇曳的火焰。

```
在这些话题上，每个人都有很长一段误解和误解的历史（有意或无意）。如果我们能避开所有这些问题，并尽可能地专注于技术讨论，我会很高兴的。参与这些讨论的每个人都想要更好的安全，即使我们采取不同的方式。如果有人觉得自己受到了侮辱，试着让它过去，把注意力集中在我们可以找到富有成效的共同点的地方，记住，任何争吵只会分散人们对手头更重要问题的注意力。
```

这个补丁集现在已经是第四版了；库克要求将其撤下至4.8。在审查过程中，已经修复了一些bug（特别是Laura Abbott对arm64的一些修复和添加）并进行了更改，但没有出现对该功能的根本分歧。在写这篇文章的时候，这些补丁还没有被移除，但是有一些先决条件，所以可能只是Torvalds还没有得到它。但是，如果不是在4.8版本中，我们很可能很快就会看到这个功能出现在主流版本中。

