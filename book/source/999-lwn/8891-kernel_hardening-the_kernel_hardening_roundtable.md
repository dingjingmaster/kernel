# LSS: The kernel hardening roundtable

在2011年9月8日举行的Linux安全峰会（LSS）上，强化内核以使攻击者的工作更加困难是一个广泛讨论的主题。减少内核的攻击面，保护它免受用户空间攻击，以及找到减轻所有可利用的漏洞的方法都在讨论中。正如预期的那样，让这些加固补丁进入主流的最大障碍通常是性能问题。虽然没有得出明确的结论，但讨论了许多想法，其中一些可能最终会成为主流。

## Attack surface(攻击面)

正如b谷歌Chrome OS团队的圆桌会议领导Will Drewry所说，讨论从量化内核的“暴露表面”开始。他和另一位圆桌会议的领导者，Ubuntu安全团队的Kees Cook，整理了他们自己的清单，但也要求在场的人加入其中。我们提到了明显的攻击面，如系统调用接口、/proc和sysfs文件、网络堆栈和设备驱动程序，但也提到了不太明显的攻击面，如文件系统解析、自动加载的内核模块、设备扫描、CPU或其他硬件错误、边信道定时攻击等等。

库克说，列举攻击面“有助于确定需要注意什么”。他说，许多内核加固补丁的目的是试图“消灭一整类问题，而不是针对单个bug”。他说，后者是当前内核安全工作的主要方向。德鲁里补充说，其目的是找出现在可以做些什么来减少这些攻击面。库克说，即使在像SELinux这样运行强制访问控制（MAC）系统的系统中，许多攻击面仍然存在，因为系统调用接口仍然可以被使用（和滥用）。他补充说，这是指望LSM接口提供约束的问题之一。

Casey Schaufler还指出，Linux系统中经常有专用硬件——过去几年是图形硬件，但现在倾向于视频硬件——允许从用户空间直接访问。他说，这带来了许多潜在的安全问题，但这不会阻止它的发生。允许直接访问这些设备所提供的功能是“如此引人注目，以至于安全问题是次要的”。

但库克说，有些内核安装对安全更敏感，即使以牺牲性能为代价，也可以通过限制某些功能来获益。如果特定的强化特性没有实际成本，那么可以将其放入内核中，而不提供禁用它的配置选项。另外一些确实有成本的功能可能是可选的，发行版或用户可以根据自己的需要启用它们。

## API / ABI的限制

Schaufler说，Linux系统中“最大的单一暴露”是以root身份运行的应用程序，比如X服务器。Cook说，因为内核是一个“巨大的特权应用程序”，所以它无法抵御其他特权应用程序，比如X。但是，德鲁里说，应用程序可以减少对它们可用的ABI，这将减少如果它们被泄露可能造成的损害。

德鲁里说，内核中唯一现有的“API管理”工具是seccomp（除了LSM接口之外），但它的限制太大，无法用于许多应用程序。由于seccomp只允许四个系统调用（read（）、write（）、exit（）和sigreturn()），因此对于许多可能降低abi的应用程序来说，它太有限了。Chrome/Chromium浏览器团队希望能够减少其渲染进程可能产生的系统调用。Seccomp对于Chromium的需求来说太有限了，所以他们实现了一个更复杂的解决方案，用一个“可信的”汇编语言线程来协调系统调用。德鲁里说，也可以使用ptrace（）来强制执行系统调用限制，但这会带来“大量的开销”。

德鲁里所寻找的是某种扩展的seccomp，其中允许系统调用的子集。到目前为止，他要实现的补丁已经从各个方向被否决了，但希望在即将到来的内核峰会上能有某种解决方案。

一些与会者对扩大二级市场的做法持怀疑态度。Schaufler指出，内核（功能）中已经有一种机制可以减少漏洞的影响，但“没有人使用它”。Cook不相信能力的粒度真的那么有用，因为相当于根的能力位的数量太大了。

当Drewry开始寻找限制系统调用的方法时，就有可能对LSM接口进行扩展的讨论。正如库克所指出的，当前的接口并不能调解所有的系统调用，所以它不能用于德鲁里的用例。James Morris指出，LSM旨在成为一个访问控制框架，仅此而已。最后，德鲁里并不特别关心如何实现这一目标，他只是在寻找一种“减少我暴露给不受信任的应用程序的东西”的方法，他说。

Schaufler还指出，减少应用程序可用的ABI并没有帮助，“如果ABI是完全定义好的，并且与系统的安全策略一致”。“有太多的‘如果’了，”德鲁里回应道，人们普遍认为Linux系统不满足这两个条件。由于系统调用接口没有良好定义，也不一定与系统安全策略一致，因此减少该接口部分的暴露可能会有所帮助。Schaufler警告说，特别的文档使得很难确定bug的实际位置：“如果代码就是文档，那么就不可能有bug”。

有一些问题是关于应用程序是否会实际使用秒比较过滤（无论以何种形式）。Cook指出，除了Chromium之外，linux-kernel上还出现了其他几个项目来表达对该特性的兴趣，包括QEMU、vsftpd等。一位与会者还假设DNS服务器仅限于recvmsg（）、sendmsg（）和write()（到日志文件）作为另一个可能的用例。

也有人担心seccomp过滤器会在整个系统中传播安全策略，但其他人认为这是一个功能。与MAC策略不同，MAC策略往往是从外部强加的，而seccomp过滤器策略将体现“程序员对它应该能做什么的想法”，正如库克所说。虽然系统调用粒度可能不完全正确，但它是用户空间进入内核的地方，因此在这一点上进行中介是有意义的。

与会者认为，如果一个灵活的seccomp过滤器设施是可用的，多个应用程序将利用它。Smalley对大多数应用程序是否能够直接使用该设施持怀疑态度，因为它可能需要对程序进行重大修改。他以OpenSSH中的特权分离工作为例。他说，这需要“重大的重构”。

德鲁里说，Chromium团队的计划是将浏览器迁移到任何可用的解决方案，以更好地包含渲染器。目前，这是“可信线程”沙箱，但如果有其他可用的工具，Chromium将使用它们。这可能是某种SELinux遏制、seccomp过滤或其他完全不同的东西。他说，在未来，该团队还希望根据数据的来源来限制渲染器，这样在给定站点上运行的所有渲染器都可以相互保护。

## PaX and grsecurity

圆桌会议最后讨论了将更多grsecurity和PaX加固补丁引入主线的问题。这些补丁往往具有相当大的侵入性，并且具有性能影响，因此许多内核黑客不喜欢它们，但是它们确实提供了一些有价值的保护。根据库克的说法，有许多grsecurity和PaX的部分可能会进入主流。

简单的事情，比如配置函数指针，基本上是免费的，应该立即被主流化。一位与会者说：“很遗憾很久以前没有这样做。”其他影响更大的则更为棘手。使它们可选是一种可能性，但即使这样也有维护人员可能会反对的成本。在核心内核代码中添加另一条路径可能是一个令人头痛的维护问题，而且这些路径可能很难进入主线。

Andre Hedrick提到，他一直在拆分grsecurity/PaX补丁，试图让它们更容易被接受。首先，grsecurity依赖于主线中不存在的基于角色的访问控制（RBAC）机制（并且没有作为LSM实现，因此不太可能是，至少以这种形式）。Hedrick正试图消除对grsecurity特性的依赖，比如更好的地址空间布局随机化（ASLR）和一个完全可重定位的内核，这两者都可以阻止各种类型的攻击。

一个目标是找到影响最小的grsecurity/PaX更改，并将其作为非可选保护纳入主线。将RBAC转变为LSM可能是另一个有用的练习。库克说，在去年的LSS大会上，grsecurity开发者布拉德·斯宾格勒（Brad Spengler）提供了一长串可能会进入内核的功能。这个清单会是一个很好的起点。

库克还提到了其他几项旨在强化内核的努力。其中包括Openwall黑客Vasiliy Kulikov一直在做的工作，其中大部分工作都在内核强化邮件列表中讨论。同时，Ubuntu安全团队也在致力于自己的内核加固项目。人们不缺乏想法，而且显然需要使内核更能抵抗攻击。基于讨论和各种正在进行的努力，我们很可能在接下来的几年中看到针对主线的越来越多的硬化补丁。


