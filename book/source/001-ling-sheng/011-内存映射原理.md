# 内存映射原理

## 物理地址空间

物理地址是处理器在系统总线上看到的地址。使用RISC的处理器通常只实现一个物理地址空间，外围设备和物理内存使用统一的物理地址空间。有些处理器架构把分配给外围设备的物理地址区域称为设备内存

处理器通过外围设备控制器的寄存器访问外围设备，寄存器分为控制寄存器，状态寄存器和数据寄存器三大类。外围设备的寄存器通常被连续的编制址，处理器对外围设备寄存编址方式分为两种：I/O映射方式（I/O-mapped）、内存映射方式（memory-mapped）

应用程序只能通过虚拟地址访问外设寄存器，内核提供API函数来把外设寄存器的物理地址映射到虚拟地址空间。

ARM64架构（物理地址宽度最大支持48位）分为两种内存类型：
- 正常内存（Normal Memory）：包括物理内存和只读存储取（ROM）
- 设备内存（Device Memory）：指分配给外围设备寄存器的物理地址区域。设备内存共享属性总是外部共享，缓存属性总是不可缓存（必须要绕过CPU的缓存）。

内存映射原理：创建内存映射时候，在进程的用户虚拟地址空间中分配一个虚拟内存区域。内核采用延迟分配物理内存的策略，在进程第一次访问虚拟页的时候，产生缺页异常。如果是文件映射，那么分配物理页，把文件指定区间的数据读到物理页中，然后在页表中把虚拟页映射到物理页。如果是匿名映射，就分配物理页，然后在页表中把虚拟页映射到物理页。

内存映射即在进程的虚拟地址空间中创建一个映射，分为两种：
- 文件映射：文件支持的内存映射，把文件的一个区间映射到进程的虚拟地址空间，数据源是存储设备上的文件
- 匿名映射：没有文件支持的内存映射，把物理内存映射到进程的虚拟地址空间，没有数据源

两个进程可以使用共享的文件映射实现共享内存。匿名映射通常是私有映射，共享的匿名映射只可能出现在父进程和子进程之间。在进程的虚拟地址空间中，代码段和数据段是私有的文件映射，未初始化数据段、堆栈是私有的匿名映射。

> 修改过的脏页面不会立即更新到文件中，可以调用msync强制同步
