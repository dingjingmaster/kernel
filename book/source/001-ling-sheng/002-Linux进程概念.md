# Linux进程概念

## 进程

进程：是计算机中已经运行的程序。

内核把进程叫做任务（task），进程的虚拟地址空间可分为用户虚拟地址空间和内核虚拟地址空间，所有进程共享内核虚拟地址空间，每个进程有独立的用户虚拟地址空间。

进程有两种特殊的形式：没有用户虚拟地址空间的进程叫内核线程，共享用户虚拟地址空间的进程叫用户线程。共享同一个用户虚拟地址空间的所有用户线程叫线程组。

## 进程概念对比

|C语言标准库进程|Linux内核进程|
|:--------------|:------------|
|包括多个线程的进程|线程组|
|只有一个线程的进程|任务或进程|
|线程|共享用户虚拟地址空间的进程|

## 进程生命周期

Linux操作系统属于多任务操作系统，系统中每个进程能够分时复用CPU时间片，通过有效的进程调度策略实现多任务并行执行。而进程在被CPU调度运行，等待CPU资源分配以及等待外部事件时会属于不同的状态态。

进程状态如下：
- 创建状态：创建新进程
- 就绪状态：进程已经获取可以运行所需资源以及相关条件
- 执行状态：进程正在CPU 中执行操作
- 阻塞状态：进程因等待资源而被跳出CPU
- 终止状态：进程销毁

```
+----------+                                                         +----------+
| 创建进程 |       +----------- 调度运行处理 ----------+             | 终止状态 |
+----------+       |                                   |             +----------+
     |             |                                  \|/                  | 
   fork()     +----------+                        +----------+      进程退出或者被杀死
     +------->| 就绪状态 |                        | 执行状态 |-------------+
              +----------+                        +----------+
              /|\   /|\                                  |  |
               |     |                                   |  |
               |     +--------- 被高优先级任务抢占-------+  |
               |                                            |
 事件资源满足，进入就绪队列  +----------+          等待特定事件或资源，进入休眠等待队列
               +-------------| 阻塞状态 |<------------------+
                             +----------+
```

## Linux内核提供API设置进程状态

- `TASK_RUNNING`(可运行状态或者可就绪状态)
- `TASK_INTERRUPTIBLE`(可中断睡眠状态，又叫浅睡眠状态)
- `TASK_UNINTERRUPTIBLE`(版本不可中断状态，又叫深度睡眠状态)；我们可以通过ps命令查看被标记为D状态的进程
- `__TASK_STOPPED`(终止状态)
- `EXIT_ZOMBIE`(僵尸状态)

## `task_struct`数据结构分析

进程是操作系统调度的一个实体，内核中将进程抽象为进程控制块（PCB，Process Control Block），在Linux内核里采用`task_struct`结构体来描述专程控制块。Linux内核涉及进程和程序的所有算法都围绕名为`task_struct`结构体来描述专程控制块。

include/sched.h

## 进程优先级

进程控制块中的字段
- prio
- static_prio
- normal_prio
- rt_priority

限期进程优先级高于实时进程，实时进程的优先级比普通进程要高
- 限期进程优先级是：-1
- 实时进程优先级是：1-99，优先级数值越大，表示优先级越高
- 普通进程静态优先级：100-139，优先级数值越小，表示优先级越高，可以通过修改nice值改变普通进程的优先级，优先级等于120+nice值

|优先级|限期进程|实时进程|普通进程|
|:----:|:------:|:------:|:------:|
|prio调度优先级（数值越小，优先级越高）|大多数情况下prio等于`normal_prio`。特殊情况，如果进程X占有实时互斥锁，进程Y正在等待锁，进程Y 的优先级比进程X优先级高，那么把进程X的优先级临时提高到进程Y的优先级，即进程X的prio的值等于进程Y的prio值|||
|static_prio静态优先级|没有意义，总是0|120+nice值，数值越小，表示优先级越高|||
|normal_prio正常优先级（数值越小优先级越高）|-1|99-rt_priority|static_prio|
|rt_priority实时优先级|没有意义，总是0|实时进程优先级，范围1-99，数值越大优先级越高|没有意义|

## 系统调用

fork()、vfork()、clone() 函数

```
           +--------+  +---------+  +---------+
用户空间   | fork() |  | vfork() |  | clone() |
           +--------+  +---------+  +---------+
---------------------------------------------------------------------
           +--------+  +---------+  +---------+  +--------------+
内核空间   |sys_fork|  |sys-vfork|  |sys_clone|  |kthread_create|
           +--------+  +---------+  +---------+  +--------------+
                |           |            |             |
                +-----------+-----+------+-------------+
                                  |
                           +---------------+
                           |   do_fork()   |
                           +---------------+
                                 \|/
                           +---------------+
                           | copy_process()|
                           +---------------+
```

## 内核线程(kthread_create)

独立运行在内核空间的进程，与普通用户进程区别在于内核线程没有独立的进程地址空间：task_struct又一个成员指针mm设置为NULL，它只能运行在内核空间。

内核线程任务：
- 周期的将修改的内存页与页来源块设备同步
- 如果内存页很少使用，则写入交换区
- 管理延时动作
- 实现文件系统的事务日志

## 退出进程

1. 调用`exit()`或从主函数返回
2. 接受到杀死信号或异常时终止
