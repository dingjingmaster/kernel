# 实时调度器及SMP和NUMA

## 实时调度类分析

Linux进程可分为两大类：实时进程和普通进程。

实时进程和普通进程的不同之处，调度器总是会选择实时进程。

- SCHED_FIFO：没有时间片，在被调度器选择之后，可以运行任意长时间
- SCHED_RR：有时间片，其值在进程运行时候会减少

实时调度实体用 sched_rt_entity 数据结构表示

include/linux/sched.h

实时类：`struct rt_rq`

实时调度类：`rt_sched_class`

### 实时调度类核心操作函数

- enqueue_task_rt：更新调度信息，将调度实体插入到响应优先级队列的末尾

....

## SMP和NUMA

### SMP（对称多处理器结构，又称UMA）

SMP所有CPU的地位都是平等的，所有的CPU共享全部资源，比如：内存、总线、中断以及I/O系统等等。没有从属关系

SMP扩展资源有限（有瓶颈），CPU数量增加、内存访问冲突增加

多处理器系统中、内核必须考虑的几个问题：
- CPU负荷尽可能公平
- 进程和某些处理器可以设置亲和力
- 内核必须能将进程从一个CPU迁移到另一个

SMP调度就是将进程安排/迁移到何时的CPU中取，保持各个CPU负载均衡的过程。

### NUMA（非一致内存访问结构）

NUMA为多处理器计算机，系统各个CPU都有本地内存，可以支持超快的访问能力，各个处理器之间通过总线链接起来，支持对其他CPU的本地内存访问（但比访问自己的内存要慢点）。

```
+------+------+ +------+------+
| 内存 | 内存 | | 内存 | 内存 |
+------+------+ +------+------+
| 内存 | 内存 | | 内存 | 内存 |
+------+------+ +------+------+
    |     |        |      |
    +-----+--------+------+
   CPU1  CPU2     CPU3   CPU4

```

CPU 访问自己内存快，访问别的CPU内存慢，每个CPU都有独立的本地内存、插槽

利用NUMA解决SMP的扩展能力

从应用层系统架构，商用服务器目前大体分为三类：
- SMP
- NUMA
- MPP


NUMA优势：一台物理服务器内部可以集成多个CPU，使系统具有较高事务处理能力。NUMA架构适合OLTP事务处理环境
SMP优势：当前使用的OTLP（面向顾客）程序中用户访问一个中断数据库，如果采用SMP系统架构，它的效率要比MPP架构快

### CPU域的初始化

根据实际物理属性，CPU分类（SMT（超线程）、MC、SoC）；从内核分类（SMT、MC、DIE）。

Linux内核对CPU的管理是通过bitmap来管理的，并且定义了4中状态：possible/present/online/active。具体内核源码处理如下：

include/linux/cpumask.h


