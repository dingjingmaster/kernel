# 虚拟地址空间内存布局

在 Linux 操作系统中，虚拟地址空间的内部又被分为内核空间和用户空间两部分，不同位数的系统，地址空间的范围也不同。比如最常见的 32 位和 64 位系统，如下所示：

32位空间地址：内核占用1g，位于最高处，剩下的3G是用户空间
```
+-------------------------------+ 0xFFFFFFFF
|  内核空间 1G                  |
+-------------------------------+ 0xC0000000
|                               |
|  用户空间 3G                  |
|                               |
+-------------------------------+ 0x0
```

64位空间地址：内核空间和用户空间都是128T，分别占据整个内存空间的最高和最低，剩下的中间部分是未定义的
```
+-------------------------------+ 0xFFFFFFFFFFFFFFFF
|  内核空间 128T                |
+-------------------------------+ 0xFFFF800000000000
|                               |
|   未定义                      |
|                               |
+-------------------------------+ 0x00007FFFFFFFF000
|  用户空间 128T                |
+-------------------------------+ 0x0
```

每个进程都各自有独立的虚拟内存，每个虚拟内存中的内核地址，关联的都是相同的物理内存。
```
     进程 1         进程 2         进程 3
 +------------+ +------------+ +------------+
 |            | |            | |            |
 |  用户空间  | |  用户空间  | |  用户空间  |
 |            | |            | |            |
++------------+-+------------+-+------------+--+
|                                              |
|                  内核空间                    |
|                                              |
+----------------------------------------------+
```

以32位系统为例，以下是用户空间分布情况：
```
+-----------------------+ 0xFFFFFFFF
|  内核空间             |
+-----------------------+ 0xC0000000
|  栈(向下增长)         |
+-----------------------+
|                       |
+-----------------------+
| 文件映射(向上增长)    |
+-----------------------+
|                       |
+-----------------------+
|  堆(向上增长)         |
+-----------------------+
| 未初始化的数据(.bass) |
+-----------------------+
| 已初始化数据(.data)   |
+-----------------------+
| 程序文件段(.text)     |
+-----------------------+ 0x0
```
- 程序文件段：包含二进制可执行代码
- 已初始化数据段：包括静态常量
- 未初始化数据段：包括未初始化静态变量
- 堆段：动态分配的内存，低地址向上增长
- 文件映射段：包括动态库、共享内存、从低地址向上增长
- 栈段：包括局部变量和函数调用的上下文等。

## malloc 分配内存的两种方式

- brk
- mmap

如果用户分配内存小于128KB，则通过`brk`申请内存；如果用户分配内存大于128KB，则通过`mmap`申请内存

malloc 分配的是虚拟内存，不访问的化不会映射到实际的物理内存，只有在访问已经分配的虚拟内存空间的时候，操作系统通过查找页表，发现虚拟内存对应的页没有在物理内存中，就会触发缺页中断，然后操作系统就会建立虚拟内存和物理内存的映射关系。

### brk 分配内存方式

调用 `brk` 方式申请内存，会在堆区分配虚拟内存

### mmap 分配内存方式

调用 `mmap` 方式申请内存，会在文件映射区域分配内存
